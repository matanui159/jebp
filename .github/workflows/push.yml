name: On Push
on: [push, pull_request]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu GCC x86-64
            runs-on: ubuntu-latest
            cc: gcc
            cflags: -Werror
          - name: Ubuntu Clang x86-64
            runs-on: ubuntu-latest
            cc: clang
            cflags: -Werror
          - name: Ubuntu MinGW x86-64
            runs-on: ubuntu-latest
            packages: gcc-mingw-w64-x86-64 wine-stable
            cflags: -Werror
            cmake-flags: -DCMAKE_TOOLCHAIN_FILE=dev/toolchain/x86_64-w64-mingw32.cmake
          - name: Ubuntu GCC x86-32
            runs-on: ubuntu-latest
            packages: gcc-i686-linux-gnu libc-dev-i386-cross qemu-user
            cflags: -Werror
            cmake-flags: -DCMAKE_TOOLCHAIN_FILE=dev/toolchain/i686-linux-gnu.cmake
          - name: Ubuntu GCC AArch64
            runs-on: ubuntu-latest
            packages: gcc-aarch64-linux-gnu libc-dev-arm64-cross qemu-user
            cflags: -Werror
            cmake-flags: -DCMAKE_TOOLCHAIN_FILE=dev/toolchain/aarch64-linux-gnu.cmake
          - name: Ubuntu GCC AArch32
            runs-on: ubuntu-latest
            packages: gcc-arm-linux-gnueabi libc-dev-armel-cross qemu-user
            cflags: -Werror
            cmake-flags: -DCMAKE_TOOLCHAIN_FILE=dev/toolchain/arm-linux-gnueabi.cmake
          - name: Ubuntu GCC AArch32 hard-float
            runs-on: ubuntu-latest
            packages: gcc-arm-linux-gnueabihf libc-dev-armhf-cross qemu-user
            cflags: -Werror
            cmake-flags: -DCMAKE_TOOLCHAIN_FILE=dev/toolchain/arm-linux-gnueabihf.cmake
          - name: Windows MSVC x86-64
            runs-on: windows-latest
          - name: MacOS Clang x86-64
            runs-on: macos-latest
            cflags: -Werror
    name: Tests (${{ matrix.name }})
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          lfs: true
      - if: matrix.packages != ''
        name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Configure project
        run: cmake -B bin -DCMAKE_BUILD_TYPE=Release ${{ matrix.cmake-flags }}
        env:
          CC: ${{ matrix.cc }}
          CFLAGS: ${{ matrix.cflags }}
      - name: Compile project
        run: cmake --build bin --config Release
      - name: Run tests
        run: ctest --test-dir bin --build-config Release
      - if: failure()
        name: Upload logs
        uses: actions/upload-artifact@v2
        with:
          name: logs
          path: |
            bin/CMakeFiles/CMakeOutput.log
            bin/CMakeFiles/CMakeError.log
            bin/Testing/Temporary/LastTest.log
            bin/Testing/Temporary/LastTestsFailed.log

  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Configure project
        run: cmake -B bin
      - name: Format code
        run: cmake --build bin --target format
      - name: Check for differences
        run: git diff --exit-code --color
